<!DOCTYPE html>
<html class="dark" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Squad - Hexa</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<style>
body { font-family: 'Inter', sans-serif; }
.glass { background: rgba(0,0,0,0.6); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); }
</style>
</head>
<body class="bg-black text-white min-h-screen">
<nav class="p-6 flex justify-between items-center glass">
<a href="/" class="text-2xl font-bold">HEXA</a>
<a href="/map" class="px-6 py-2 bg-teal-500 rounded-full font-bold">Back to Map</a>
</nav>

<main class="max-w-6xl mx-auto p-8">
<div id="noSquad" style="display:none;">
<h1 class="text-5xl font-black mb-8">Join a Squad</h1>
<div class="mb-6">
<button onclick="showCreateSquad()" class="px-8 py-4 bg-teal-500 rounded-2xl font-bold text-lg">Create New Squad</button>
</div>
<div id="squadList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
</div>

<div id="createSquad" style="display:none;" class="glass p-8 rounded-3xl max-w-md mx-auto">
<h2 class="text-3xl font-bold mb-6">Create Squad</h2>
<input id="squadName" type="text" placeholder="Squad Name" class="w-full p-4 bg-zinc-900 rounded-xl mb-4 text-white"/>
<button onclick="createSquad()" class="w-full py-4 bg-teal-500 rounded-xl font-bold">Create</button>
</div>

<div id="squadView" style="display:none;">
<div class="flex justify-between items-center mb-8">
<h1 class="text-5xl font-black" id="squadName"></h1>
<button onclick="leaveSquad()" class="px-6 py-3 bg-red-500 rounded-xl font-bold">Leave Squad</button>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
<div class="glass p-6 rounded-3xl">
<h3 class="text-2xl font-bold mb-4 flex items-center gap-2">
<span class="material-symbols-outlined">group</span>
Members
</h3>
<div id="memberList" class="space-y-2"></div>
</div>

<div class="glass p-6 rounded-3xl">
<h3 class="text-2xl font-bold mb-4 flex items-center gap-2">
<span class="material-symbols-outlined">flag</span>
Missions
</h3>
<div id="missionList" class="space-y-3"></div>
</div>
</div>

<div class="glass p-6 rounded-3xl mt-6">
<h3 class="text-2xl font-bold mb-4">Squad Chat</h3>
<div id="chatMessages" class="h-64 overflow-y-auto mb-4 space-y-2"></div>
<div class="flex gap-2">
<input id="chatInput" type="text" placeholder="Type message..." class="flex-1 p-3 bg-zinc-900 rounded-xl"/>
<button onclick="sendMessage()" class="px-6 py-3 bg-teal-500 rounded-xl font-bold">Send</button>
</div>
</div>
</div>
</main>

<script>
const userId = localStorage.getItem('userId') || 1;
let currentSquadId = null;
let userFaction = null;

async function loadUserData() {
  const res = await fetch(`/api/stats/${userId}`);
  const data = await res.json();
  userFaction = data.faction;
  
  const [user] = await (await fetch(`/api/auth/user/${userId}`)).json();
  if (user && user.squad_id) {
    currentSquadId = user.squad_id;
    loadSquad();
  } else {
    document.getElementById('noSquad').style.display = 'block';
    loadSquadList();
  }
}

async function loadSquadList() {
  const res = await fetch(`/api/squads/list/${userFaction}`);
  const data = await res.json();
  const list = document.getElementById('squadList');
  list.innerHTML = data.squads.map(s => `
    <div class="glass p-6 rounded-2xl">
      <h3 class="text-xl font-bold mb-2">${s.name}</h3>
      <p class="text-zinc-400 mb-4">${s.member_count} members</p>
      <button onclick="joinSquad(${s.id})" class="px-6 py-2 bg-teal-500 rounded-xl font-bold">Join</button>
    </div>
  `).join('');
}

function showCreateSquad() {
  document.getElementById('noSquad').style.display = 'none';
  document.getElementById('createSquad').style.display = 'block';
}

async function createSquad() {
  const name = document.getElementById('squadName').value;
  const res = await fetch('/api/squad/create', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ userId, name, faction: userFaction })
  });
  const data = await res.json();
  if (data.success) {
    currentSquadId = data.squadId;
    location.reload();
  }
}

async function joinSquad(squadId) {
  const res = await fetch('/api/squad/join', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ userId, squadId })
  });
  const data = await res.json();
  if (data.success) location.reload();
  else alert(data.message);
}

async function loadSquad() {
  const res = await fetch(`/api/squad/${currentSquadId}`);
  const data = await res.json();
  
  document.getElementById('squadView').style.display = 'block';
  document.getElementById('squadName').textContent = data.squad.name;
  
  document.getElementById('memberList').innerHTML = data.members.map(m => `
    <div class="flex justify-between items-center p-3 bg-zinc-900 rounded-xl">
      <span class="font-bold">${m.username}</span>
      <span class="text-teal-400">${m.exp_points} XP</span>
    </div>
  `).join('');
  
  document.getElementById('missionList').innerHTML = data.missions.map(m => `
    <div class="p-4 bg-zinc-900 rounded-xl">
      <p class="font-bold mb-2">Capture hex: ${m.target_h3.substring(0,10)}</p>
      <button onclick="completeMission(${m.id})" class="px-4 py-2 bg-teal-500 rounded-lg text-sm font-bold">Complete</button>
    </div>
  `).join('');
}

async function completeMission(missionId) {
  const res = await fetch('/api/squad/mission/complete', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ missionId, squadId: currentSquadId })
  });
  const data = await res.json();
  if (data.success) {
    alert(`Mission complete! +${data.reward} XP for all members!`);
    loadSquad();
  }
}

async function leaveSquad() {
  if (confirm('Leave squad?')) {
    await fetch('/api/squad/leave', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId })
    });
    location.reload();
  }
}

function sendMessage() {
  const msg = document.getElementById('chatInput').value;
  if (!msg) return;
  const chat = document.getElementById('chatMessages');
  chat.innerHTML += `<div class="p-3 bg-zinc-900 rounded-xl"><b>You:</b> ${msg}</div>`;
  document.getElementById('chatInput').value = '';
  chat.scrollTop = chat.scrollHeight;
}

loadUserData();
</script>
</body>
</html>
