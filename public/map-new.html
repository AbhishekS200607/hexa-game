<!DOCTYPE html>
<html class="dark" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Hexa - High-Contrast Conquest Map</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,typography,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;600;800&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet"/>
<script>
tailwind.config = {
  darkMode: "class",
  theme: {
    extend: {
      colors: {
        'accent-teal': "#4ADEBD",
        'accent-orange': "#FF6B35",
        'accent-blue': "#2D7FF9",
        "background-dark": "#000000",
      },
      fontFamily: {
        display: ["Outfit", "sans-serif"],
        sans: ["Inter", "sans-serif"],
      },
      borderRadius: {
        DEFAULT: "1.5rem",
        '2xl': '2rem',
        '3xl': '2.5rem',
      },
    },
  },
};
</script>
<style type="text/tailwindcss">
:root {
  --teal: #4ADEBD;
  --orange: #FF6B35;
  --blue: #2D7FF9;
}
.hex-grid-bg {
  background-color: #000000;
  background-image: radial-gradient(circle at 50% 50%, rgba(74, 222, 189, 0.05) 0%, transparent 70%);
}
.pulse-marker {
  position: relative;
  width: 16px;
  height: 16px;
  background-color: var(--teal);
  border-radius: 50%;
  box-shadow: 0 0 15px var(--teal);
}
.pulse-marker::after {
  content: "";
  position: absolute;
  width: 100%;
  height: 100%;
  background-color: var(--teal);
  border-radius: 50%;
  animation: pulse 2.5s infinite;
}
@keyframes pulse {
  0% { transform: scale(1); opacity: 0.6; }
  100% { transform: scale(4); opacity: 0; }
}
@keyframes pulse-ring {
  0% { transform: scale(1); opacity: 0.8; }
  100% { transform: scale(2); opacity: 0; }
}
.player-avatar { background: transparent !important; border: none !important; }
.hex-label { background: transparent !important; border: none !important; }
.glass-panel {
  background: rgba(18, 18, 18, 0.8);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.1);
}
#map { position: absolute; inset: 0; z-index: 1; }
.leaflet-tile-pane { filter: none; }
</style>
</head>
<body class="bg-background-dark text-white font-sans overflow-hidden h-screen">
<div class="relative w-full h-full hex-grid-bg">
<div id="map"></div>

<div class="absolute top-8 left-8 right-8 flex justify-between items-center z-[1000]">
<div class="flex items-center gap-4">
<a href="/" class="w-14 h-14 bg-black/40 border border-white/10 rounded-2xl flex items-center justify-center cursor-pointer hover:bg-white/5 transition-all">
<span class="material-symbols-outlined text-white text-3xl">menu</span>
</a>
<div class="px-8 h-14 bg-black/40 border border-white/10 rounded-2xl flex items-center gap-4">
<span class="material-symbols-outlined text-accent-teal">near_me</span>
<span class="font-bold text-sm text-white tracking-wide" id="locationText">Locating...</span>
</div>
</div>
<div class="flex items-center gap-4">
<div class="w-14 h-14 bg-black/40 border border-white/10 rounded-2xl flex items-center justify-center cursor-pointer hover:bg-white/5 transition-all relative">
<span class="material-symbols-outlined text-white">notifications</span>
<div class="absolute top-4 right-4 w-2 h-2 bg-accent-orange rounded-full"></div>
</div>
<div class="flex items-center gap-4 bg-black/40 border border-white/10 px-4 py-2 rounded-2xl">
<div class="text-right">
<p class="text-[10px] text-zinc-500 font-black uppercase tracking-tighter" id="userLevel">Level 1</p>
<p class="text-sm font-bold text-white" id="userName">Player</p>
</div>
<div class="w-10 h-10 rounded-xl bg-accent-teal flex items-center justify-center ring-2 ring-white/10 font-bold text-black" id="userAvatar">P</div>
</div>
</div>
</div>

<div class="absolute left-8 top-1/2 -translate-y-1/2 z-[1000] space-y-4 w-80 max-w-[calc(100vw-16rem)]" id="statsPanel">
<div class="glass-panel p-8 rounded-[2.5rem] shadow-2xl border-white/5">
<div class="flex items-center justify-between mb-8" id="recordingIndicator" style="display:none;">
<h3 class="font-display font-black text-2xl tracking-tight uppercase">Recording</h3>
<span class="flex h-2.5 w-2.5 rounded-full bg-red-500 animate-pulse"></span>
</div>
<div class="space-y-4" id="statsCards">
<div class="bg-accent-teal p-6 rounded-3xl text-black relative overflow-hidden">
<div class="relative z-10">
<div class="flex items-center gap-2 mb-1">
<span class="material-symbols-outlined text-black/60 text-lg">speed</span>
<span class="text-[11px] font-black uppercase tracking-widest text-black/60">Speed</span>
</div>
<div class="flex items-baseline gap-1">
<span class="text-4xl font-display font-black" id="speedValue">0</span>
<span class="text-sm font-bold opacity-60">km/h</span>
</div>
</div>
</div>
<div class="bg-accent-orange p-6 rounded-3xl text-black relative overflow-hidden">
<div class="relative z-10">
<div class="flex items-center gap-2 mb-1">
<span class="material-symbols-outlined text-black/60 text-lg">grid_view</span>
<span class="text-[11px] font-black uppercase tracking-widest text-black/60">Current Hex</span>
</div>
<p class="text-lg font-mono font-bold truncate" id="currentHex">-</p>
</div>
</div>
<div class="bg-accent-orange p-6 rounded-3xl text-black relative overflow-hidden">
<div class="relative z-10">
<div class="flex items-center gap-2 mb-1">
<span class="material-symbols-outlined text-black/60 text-lg">route</span>
<span class="text-[11px] font-black uppercase tracking-widest text-black/60">Run Distance</span>
</div>
<div class="flex items-baseline gap-1">
<span class="text-3xl font-display font-black" id="runDistanceValue">0.00</span>
<span class="text-sm font-bold opacity-60">km</span>
</div>
</div>
</div>
<div class="bg-accent-blue p-6 rounded-3xl text-white relative overflow-hidden">
<div class="relative z-10">
<div class="flex items-center gap-2 mb-1">
<span class="material-symbols-outlined text-white/60 text-lg">timer</span>
<span class="text-[11px] font-black uppercase tracking-widest text-white/60">Duration</span>
</div>
<div class="flex items-baseline gap-1">
<span class="text-3xl font-display font-black" id="durationValue">00:00</span>
</div>
</div>
</div>
</div>
<div class="mt-8 pt-6 border-t border-white/10 flex justify-between">
<div>
<p class="text-[10px] font-black text-zinc-500 uppercase tracking-widest mb-1">Captured</p>
<p class="text-2xl font-display font-black text-white"><span id="capturedCount">0</span> <span class="text-xs font-bold text-zinc-500 uppercase">Hexes</span></p>
</div>
<div class="text-right">
<p class="text-[10px] font-black text-zinc-500 uppercase tracking-widest mb-1">Energy</p>
<p class="text-2xl font-display font-black text-white" id="energyValue">100</p>
</div>
</div>
</div>
<div class="glass-panel p-5 rounded-[2rem] flex items-center gap-4 border-white/5">
<div class="w-14 h-14 rounded-2xl bg-accent-teal/10 flex items-center justify-center">
<span class="material-symbols-outlined text-accent-teal text-3xl">emoji_events</span>
</div>
<div>
<p class="text-sm font-black text-white uppercase tracking-tight" id="statusMessage">GPS Active</p>
<div class="flex items-center gap-2 mt-1">
<div class="h-1.5 w-24 bg-zinc-800 rounded-full overflow-hidden">
<div class="h-full bg-accent-teal" id="progressBar" style="width: 0%"></div>
</div>
<p class="text-[10px] font-bold text-zinc-400" id="progressText">0%</p>
</div>
</div>
</div>
<div class="glass-panel p-5 rounded-[2rem] flex items-center gap-4 border-white/5 mt-4">
<div>
<p class="text-[10px] font-black text-zinc-500 uppercase tracking-widest mb-1">Distance</p>
<p class="text-2xl font-display font-black text-white"><span id="distanceValue">0</span> <span class="text-xs font-bold text-zinc-500 uppercase">km</span></p>
</div>
</div>
</div>
</div>

<button id="runToggle" class="absolute left-8 bottom-8 z-[1000] w-80 max-w-[calc(100vw-16rem)] p-6 rounded-3xl flex items-center justify-center gap-4 border-2 border-accent-teal bg-accent-teal text-black font-display font-black text-xl uppercase tracking-tight active:scale-95 transition-all shadow-[0_20px_50px_rgba(74,222,189,0.3)] hidden md:flex" onclick="toggleRun()">
<span class="material-symbols-outlined text-4xl font-black" id="runIcon">play_circle</span>
<span id="runText">Start Run</span>
</button>

<div class="absolute right-8 top-1/2 -translate-y-1/2 z-[1000] flex flex-col gap-4">
<div class="bg-black/40 border border-white/10 p-2 rounded-2xl flex flex-col gap-2">
<button class="w-12 h-12 rounded-xl flex items-center justify-center hover:bg-white/10 transition-all text-white" onclick="map.zoomIn();">
<span class="material-symbols-outlined">add</span>
</button>
<div class="h-px bg-white/10 mx-2"></div>
<button class="w-12 h-12 rounded-xl flex items-center justify-center hover:bg-white/10 transition-all text-white" onclick="map.zoomOut();">
<span class="material-symbols-outlined">remove</span>
</button>
</div>
<button class="w-16 h-16 bg-black/40 border border-white/10 rounded-2xl flex items-center justify-center hover:bg-white/10 transition-all text-accent-teal shadow-xl" onclick="centerMap()">
<span class="material-symbols-outlined text-3xl">my_location</span>
</button>
<a href="/items" class="w-16 h-16 bg-black/40 border border-white/10 rounded-2xl flex items-center justify-center hover:bg-white/10 transition-all text-white shadow-xl">
<span class="material-symbols-outlined text-3xl">inventory_2</span>
</a>
<button class="w-16 h-16 bg-black/40 border border-white/10 rounded-2xl flex items-center justify-center hover:bg-white/10 transition-all text-yellow-400 shadow-xl" onclick="setHomeBase()" title="Set Home Base">
<span class="material-symbols-outlined text-3xl">home</span>
</button>
<a href="/squad" class="w-16 h-16 bg-black/40 border border-white/10 rounded-2xl flex items-center justify-center hover:bg-white/10 transition-all text-purple-400 shadow-xl" title="Squad">
<span class="material-symbols-outlined text-3xl">group</span>
</a>
</div>

<div class="absolute bottom-10 left-1/2 -translate-x-1/2 z-[1000] w-full max-w-md px-8 text-center md:hidden">
<button id="runToggleMobile" class="w-full bg-accent-teal hover:bg-white text-black font-display font-black py-6 rounded-[2.5rem] shadow-[0_20px_50px_rgba(74,222,189,0.3)] flex items-center justify-center gap-4 transition-all active:scale-95" onclick="toggleRun()">
<span class="material-symbols-outlined text-3xl font-black" id="runIconMobile">play_circle</span>
<span class="tracking-tight text-xl uppercase" id="runTextMobile">Start Run</span>
</button>
</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/h3-js@4.1.0/dist/h3-js.umd.js"></script>
<script src="/js/gps.js"></script>
<script>
const userId = localStorage.getItem('userId') || 1;
let currentH3Index = null;
let map = null;
let lastPosition = null;
let lastMoveTime = Date.now();
let currentHexLayer = null;
let visitedHexesLayer = null;
let ws = null;
let runId = null;
let runActive = false;
let runPath = null;
let runStartTime = null;
let runDistance = 0;
let durationInterval = null;

const FACTION_COLORS = {
  NEON_SYNDICATE: '#4ADEBD',
  WILDKEEPERS: '#85c3a8',
  IRON_VANGUARD: '#FF6B35'
};

function connectWebSocket() {
  const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${protocol}//${window.location.host}`);
  
  ws.onopen = () => {
    ws.send(JSON.stringify({ type: 'register', userId: parseInt(userId) }));
  };
  
  ws.onmessage = (event) => {
    const { event: eventType, data } = JSON.parse(event.data);
    
    if (eventType === 'territory_lost') {
      showNotification('‚ö†Ô∏è Territory Lost!', `Hex ${data.h3Index.substring(0, 8)} was captured`);
      loadVisitedHexes();
    } else if (eventType === 'territory_update') {
      loadVisitedHexes();
    }
  };
  
  ws.onclose = () => setTimeout(connectWebSocket, 3000);
}

function showNotification(title, body) {
  if ('Notification' in window && Notification.permission === 'granted') {
    new Notification(title, { body });
  }
  document.getElementById('statusMessage').textContent = title;
}

if ('Notification' in window && Notification.permission === 'default') {
  Notification.requestPermission();
}

connectWebSocket();
setInterval(loadVisitedHexes, 30000);

map = L.map('map', { zoomControl: false }).setView([0, 0], 18);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '¬© OpenStreetMap',
  maxZoom: 20
}).addTo(map);

currentHexLayer = L.layerGroup().addTo(map);
visitedHexesLayer = L.layerGroup().addTo(map);
runPath = L.polyline([], { color: '#4ADEBD', weight: 4, opacity: 0.8 }).addTo(map);

loadVisitedHexes();
loadUserData();

async function toggleRun() {
  if (!runActive) {
    const res = await fetch('/api/run/start', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId })
    });
    const data = await res.json();
    runId = data.runId;
    runActive = true;
    runStartTime = Date.now();
    runDistance = 0;
    runPath.setLatLngs([]);
    document.getElementById('recordingIndicator').style.display = 'flex';
    document.getElementById('runIcon').textContent = 'stop_circle';
    document.getElementById('runText').textContent = 'Stop Run';
    if (document.getElementById('runIconMobile')) {
      document.getElementById('runIconMobile').textContent = 'stop_circle';
      document.getElementById('runTextMobile').textContent = 'Stop Run';
    }
    durationInterval = setInterval(() => {
      const elapsed = Math.floor((Date.now() - runStartTime) / 1000);
      const mins = Math.floor(elapsed / 60);
      const secs = elapsed % 60;
      document.getElementById('durationValue').textContent = `${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
    }, 1000);
  } else {
    clearInterval(durationInterval);
    const res = await fetch('/api/run/stop', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ runId })
    });
    const data = await res.json();
    runActive = false;
    document.getElementById('recordingIndicator').style.display = 'none';
    document.getElementById('runIcon').textContent = 'play_circle';
    document.getElementById('runText').textContent = 'Start Run';
    if (document.getElementById('runIconMobile')) {
      document.getElementById('runIconMobile').textContent = 'play_circle';
      document.getElementById('runTextMobile').textContent = 'Start Run';
    }
    alert(`Run Complete!\nDistance: ${data.distance.toFixed(2)}km`);
  }
}

async function loadUserData() {
  try {
    const response = await fetch(`/api/stats/${userId}`);
    const data = await response.json();
    
    document.getElementById('userName').textContent = data.username;
    document.getElementById('userAvatar').textContent = data.username[0].toUpperCase();
    document.getElementById('userLevel').textContent = `Level ${Math.floor(data.exp / 100) + 1} ${data.player_class}`;
    document.getElementById('capturedCount').textContent = data.hexes;
    document.getElementById('energyValue').textContent = data.energy;
    document.getElementById('distanceValue').textContent = data.distance.toFixed(1);
  } catch (error) {
    console.error('Failed to load user data:', error);
  }
}

async function setHomeBase() {
  const btn = event.target.closest('button');
  btn.disabled = true;
  btn.innerHTML = '<span class="material-symbols-outlined text-3xl animate-spin">refresh</span>';
  
  if (!navigator.geolocation) {
    alert('GPS not supported');
    btn.disabled = false;
    btn.innerHTML = '<span class="material-symbols-outlined text-3xl">home</span>';
    return;
  }
  
  navigator.geolocation.getCurrentPosition(async (position) => {
    const res = await fetch('/api/home/set', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        userId, 
        lat: position.coords.latitude, 
        lng: position.coords.longitude 
      })
    });
    const data = await res.json();
    if (data.success) {
      alert('üè† Home base set! Capture hexes here for bonus XP!');
    }
    btn.disabled = false;
    btn.innerHTML = '<span class="material-symbols-outlined text-3xl">home</span>';
  }, (error) => {
    if (error.code === error.TIMEOUT) {
      alert('GPS timeout. Try again or move to open area.');
    } else {
      alert('GPS error: ' + error.message);
    }
    btn.disabled = false;
    btn.innerHTML = '<span class="material-symbols-outlined text-3xl">home</span>';
  }, {
    enableHighAccuracy: true,
    timeout: 30000,
    maximumAge: 5000
  });
}

async function loadVisitedHexes() {
  try {
    const response = await fetch(`/api/map/${userId}`);
    const data = await response.json();
    
    console.log('Loaded hex data:', data);
    
    visitedHexesLayer.clearLayers();
    
    if (!data.hexData || data.hexData.length === 0) {
      console.log('No hexes to display');
      return;
    }
    
    data.hexData.forEach(hex => {
      const center = h3.cellToLatLng(hex.h3Index);
      
      const defenseColors = ['#4ADEBD', '#85c3a8', '#FFD700', '#FF8C56', '#FF4757'];
      const circleColor = defenseColors[hex.defenseLevel - 1] || hex.color;
      const opacity = 0.2 + (hex.defenseLevel * 0.1);
      
      L.circle([center[0], center[1]], {
        radius: 60,
        color: circleColor,
        fillColor: circleColor,
        fillOpacity: opacity,
        weight: 2 + hex.defenseLevel,
        opacity: 0.6 + (hex.defenseLevel * 0.08)
      }).addTo(visitedHexesLayer);
      
      const label = L.marker([center[0], center[1]], {
        icon: L.divIcon({
          className: 'hex-label',
          html: `<div style="background:rgba(0,0,0,0.7);color:white;padding:4px 8px;border-radius:8px;font-size:11px;font-weight:bold;white-space:nowrap;">${hex.ownerName || 'Unknown'} ‚≠ê${hex.defenseLevel}</div>`,
          iconSize: [100, 30],
          iconAnchor: [50, 15]
        })
      }).addTo(visitedHexesLayer);
    });
  } catch (error) {
    console.error('Failed to load visited hexes:', error);
  }
}

function calculateSpeed(lat1, lng1, lat2, lng2, timeMs) {
  const R = 6371e3;
  const œÜ1 = lat1 * Math.PI / 180;
  const œÜ2 = lat2 * Math.PI / 180;
  const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
  const ŒîŒª = (lng2 - lng1) * Math.PI / 180;

  const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
    Math.cos(œÜ1) * Math.cos(œÜ2) *
    Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  const distance = R * c;

  return (distance / 1000) / (timeMs / 3600000);
}

function updateHexagon(lat, lng) {
  const h3Index = h3.latLngToCell(lat, lng, 9);

  currentHexLayer.clearLayers();

  document.getElementById('currentHex').textContent = h3Index.substring(0, 13);

  if (h3Index !== currentH3Index) {
    currentH3Index = h3Index;
    
    let speed = 0;
    if (lastPosition) {
      const now = Date.now();
      speed = calculateSpeed(lastPosition.lat, lastPosition.lng, lat, lng, now - lastMoveTime);
      lastMoveTime = now;
    }
    lastPosition = { lat, lng };
    
    document.getElementById('speedValue').textContent = speed.toFixed(1);
    captureHex(lat, lng, h3Index, speed);
  }
}

async function captureHex(lat, lng, h3Index, speed) {
  if (runActive && runId) {
    if (lastPosition) {
      const R = 6371;
      const dLat = (lat - lastPosition.lat) * Math.PI / 180;
      const dLng = (lng - lastPosition.lng) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lastPosition.lat * Math.PI / 180) * Math.cos(lat * Math.PI / 180) * Math.sin(dLng/2) * Math.sin(dLng/2);
      runDistance += 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      document.getElementById('runDistanceValue').textContent = runDistance.toFixed(2);
    }
    fetch('/api/run/point', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ runId, latitude: lat, longitude: lng, accuracy: 10, timestamp: Date.now() })
    });
    runPath.addLatLng([lat, lng]);
  }
  
  try {
    const response = await fetch('/api/move', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ lat, lng, h3Index, userId, speed })
    });

    const data = await response.json();
    
    if (response.status === 429) {
      document.getElementById('statusMessage').textContent = 'Rate limited - wait 10s';
      return;
    }
    
    if (data.passiveMode) {
      document.getElementById('statusMessage').textContent = 'Passive Mode';
    } else if (data.success) {
      document.getElementById('statusMessage').textContent = data.message;
      document.getElementById('capturedCount').textContent = data.stats.hexes;
      document.getElementById('energyValue').textContent = data.stats.energy;
      document.getElementById('distanceValue').textContent = data.stats.distance.toFixed(1);
      loadVisitedHexes();
    }
  } catch (error) {
    console.error('Capture error:', error);
  }
}

function centerMap() {
  if (lastPosition) {
    map.setView([lastPosition.lat, lastPosition.lng], 18);
  }
}

function stopTracking() {
  if (confirm('Stop tracking and return to dashboard?')) {
    window.location.href = '/';
  }
}

let playerMarker = null;

startTracking((position) => {
  if (!lastPosition) {
    map.setView([position.lat, position.lng], 18);
  }
  
  if (playerMarker) {
    playerMarker.setLatLng([position.lat, position.lng]);
  } else {
    const avatarIcon = L.divIcon({
      className: 'player-avatar',
      html: `<div style="position:relative;width:50px;height:50px;">
        <div style="position:absolute;width:50px;height:50px;border-radius:50%;background:rgba(74,222,189,0.2);border:3px solid #4ADEBD;animation:pulse-ring 2s infinite;"></div>
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:20px;height:20px;border-radius:50%;background:#4ADEBD;box-shadow:0 0 20px #4ADEBD;"></div>
      </div>`,
      iconSize: [50, 50],
      iconAnchor: [25, 25]
    });
    playerMarker = L.marker([position.lat, position.lng], { icon: avatarIcon, zIndexOffset: 1000 }).addTo(map);
  }
  
  updateHexagon(position.lat, position.lng);
  document.getElementById('locationText').textContent = 'GPS Active';
});
</script>
<script src="/js/theme-toggle.js"></script>
</body>
</html>
